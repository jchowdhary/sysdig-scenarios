We will now add a few custom rules, which we will explain shortly:

`helm upgrade falco stable/falco -f custom_rules.yaml`{{execute}}

It turns out our web application is faulty and susceptible to [SQL injection](https://en.wikipedia.org/wiki/SQL_injection) attacks:

![SQL injection](/sysdig/courses/falco/forensics-k8s/assets/03_sql_injection.png)

`kubectl exec client -n ping -- curl -F "s=OK" -F "user=bad" -F "passwd=wrongpasswd' OR 'a'='a" -F "ipaddr=localhost" -X POST http://ping/ping.php`{{execute}}

An attacker can not only bypass the authentication mechanism, but even execute arbitrary commands:

![Arbitrary command](/sysdig/courses/falco/forensics-k8s/assets/04_arbitrary_command.png)

`kubectl exec client -n ping -- curl -F "s=OK" -F "user=bad" -F "passwd=wrongpasswd' OR 'a'='a" -F "ipaddr=localhost; ps aux" -X POST http://ping/ping.php`{{execute}}

The attacker could easily get the source code for our ping app, which contains the database credentials:

`kubectl exec client -n ping -- curl -F "s=OK" -F "user=bad" -F "passwd=wrongpasswd' OR 'a'='a" -F "ipaddr=localhost; cat /var/www/html/ping.php" -X POST http://ping/ping.php`{{execute}}

Detection with Falco
--------------------

Falco help us detect this kind of attacks thanks to this custom rule:

```yaml
- rule: Unauthorized process
  desc: There is a running process not described in the base template
  condition: spawned_process and container and k8s.ns.name=ping and k8s.deployment.name=ping and not proc.name in (apache2, sh, ping)
  output: Unauthorized process (%proc.cmdline) running in (%container.id)
  priority: ERROR
  tags: [process]
```

Notice how in the rule condition we make use of Kubernetes metadata:
`k8s.ns.name=ping and k8s.deployment.name=ping`

You can find all the available fields in the [documentation](https://github.com/draios/sysdig/wiki/Sysdig-User-Guide#all-supported-filters).

Take a look at the logs generated by Falco:

`kubectl logs --selector app=falco`{{execute}}

You should see something like:

`18:37.06.570052961: Error Unauthorized process (cat /var/www/html/ping.php) running in (f34f277537e4) k8s.ns=ping k8s.pod=ping-5dffbc654-qrr6m container=f34f277537e4`
